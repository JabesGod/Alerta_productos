{% extends 'base.html' %}
{% load static %}

{% block title %}Categor√≠as{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">üìÇ Lista de Categor√≠as</h2>

    <div class="d-flex gap-2">
        <form method="GET" action="{% url 'lista_categorias' %}" class="d-flex gap-2">
            <!-- üîç Campo de b√∫squeda -->
            <input type="text" name="q" class="form-control w-auto" placeholder="Buscar categor√≠a"
                value="{{ request.GET.q }}">

            <!-- üîÑ Bot√≥n de Refresh -->
            <button class="btn btn-secondary" type="button" onclick="location.href='{% url 'lista_categorias' %}'">
                <i class="fas fa-sync-alt"></i>
            </button>
            {% if request.user.is_superuser %}
            <!-- ‚ûï Bot√≥n para agregar categor√≠a -->
            <button type="button" id="abrirModalBtn" class="btn btn-success">
                Agregar categor√≠a
            </button>
            {% endif %}

        </form>

    </div>

    <table class="table table-striped table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>üìå Nombre</th>
                <th>‚öôÔ∏è Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for categoria in categorias %}
            <tr data-fila-id="{{ categoria.id }}">
                <td class="nombre-categoria">{{ categoria.nombre }}</td>
                <td>
                    {% if request.user.is_superuser %}
                    <!-- Bot√≥n Editar -->
                    <button class="btn btn-warning editar-btn" data-id="{{ categoria.id }}"
                        data-nombre="{{ categoria.nombre }}" data-bs-toggle="modal"
                        data-bs-target="#editarCategoriaModal">
                        ‚úèÔ∏è Editar
                    </button>

                    <!-- Bot√≥n Eliminar -->
                    <button class="btn btn-danger eliminar-btn" data-id="{{ categoria.id }}"
                        data-nombre="{{ categoria.nombre }}" data-bs-toggle="modal"
                        data-bs-target="#eliminarCategoriaModal">
                        üóëÔ∏è Eliminar
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center text-danger">
                    üö® No se encontraron categor√≠as con ese nombre.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    <!-- FORMULARIO PARA AGREGAR CATEGOR√çA -->
    <div class="modal fade" id="agregarCategoriaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚ûï Agregar Categor√≠a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'agregar_categoria' %}" method="post">
                        {% csrf_token %}
                        <label><strong>Nombre:</strong></label>
                        <input type="text" name="nombre" id="nombre_categoria" class="form-control" required>
                        <br>
                        <button type="submit" class="btn btn-primary w-100 shadow">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="editarCategoriaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è Editar Categor√≠a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="editarCategoriaMensaje"></div> <!-- Contenedor para mensajes -->
                    <form id="editarCategoriaForm" method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="id" id="edit_categoria_id">
                        <label><strong>Nombre:</strong></label>
                        <input type="text" name="nombre" class="form-control" id="edit_categoria_nombre" required>
                        <br>
                        <button type="submit" class="btn btn-success w-100 shadow">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div class="modal fade" id="eliminarCategoriaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üóëÔ∏è Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas eliminar la categor√≠a <strong
                            id="nombre_categoria_eliminar"></strong>?</p>
                    <input type="hidden" id="categoria_id_eliminar">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarEliminarBtn">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    {% endblock %}

    {% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // üëâ Abrir el modal de agregar categor√≠a
            document.getElementById('abrirModalBtn')?.addEventListener('click', function () {
                let modal = new bootstrap.Modal(document.getElementById('agregarCategoriaModal'));
                modal.show();
            });

            // üëâ Abrir el modal de edici√≥n y cargar los datos
            document.querySelectorAll('.editar-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let categoriaId = this.getAttribute('data-id');
                    let categoriaNombre = this.getAttribute('data-nombre');

                    // Asignar valores a los inputs del formulario de edici√≥n
                    document.getElementById('edit_categoria_id').value = categoriaId;
                    document.getElementById('edit_categoria_nombre').value = categoriaNombre;

                    // Actualizar la URL del formulario din√°micamente
                    document.getElementById('editarCategoriaForm').action = `/editar_categoria/${categoriaId}/`;
                });
            });

            // üëâ Enviar el formulario de edici√≥n por AJAX
            document.getElementById('editarCategoriaForm')?.addEventListener('submit', function (e) {
                e.preventDefault();  // Evita la recarga de la p√°gina

                let formData = new FormData(this);
                let categoriaId = document.getElementById('edit_categoria_id').value;
                let mensajeDiv = document.getElementById('editarCategoriaMensaje');

                fetch(`/editar_categoria/${categoriaId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    body: formData
                })
                    .then(response => response.json())  // Asegura que la respuesta es JSON
                    .then(data => {
                        if (data.mensaje) {
                            mensajeDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${data.mensaje}</div>`;

                            // **Actualizar la categor√≠a en la tabla sin recargar**
                            let categoriaFila = document.querySelector(`[data-fila-id="${categoriaId}"]`);
                            if (categoriaFila) {
                                categoriaFila.querySelector('.nombre-categoria').textContent = formData.get('nombre');
                            }

                            // Cerrar el modal de edici√≥n
                            setTimeout(() => {
                                let modal = new bootstrap.Modal(document.getElementById('editarCategoriaModal'));
                                modal.hide();
                            }, 1500);
                        } else {
                            mensajeDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mensajeDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error al procesar la solicitud.</div>`;
                    });
            });

            // üëâ Configurar el modal de eliminaci√≥n
            let eliminarCategoriaModal = new bootstrap.Modal(document.getElementById('eliminarCategoriaModal'));

            // Abrir el modal de eliminaci√≥n y cargar datos
            document.querySelectorAll('.eliminar-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let categoriaId = this.getAttribute('data-id');
                    let categoriaNombre = this.getAttribute('data-nombre');

                    document.getElementById('categoria_id_eliminar').value = categoriaId;
                    document.getElementById('nombre_categoria_eliminar').textContent = categoriaNombre;
                });
            });

            // Confirmar eliminaci√≥n
            document.getElementById('confirmarEliminarBtn')?.addEventListener('click', function () {
                let categoriaId = document.getElementById('categoria_id_eliminar').value;

                fetch(`/eliminar_categoria/${categoriaId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.mensaje) {
                            // Cerrar el modal
                            eliminarCategoriaModal.hide();

                            // Eliminar la fila de la tabla sin recargar la p√°gina
                            document.querySelector(`[data-fila-id="${categoriaId}"]`)?.remove();

                            // Mostrar un mensaje de √©xito
                            alert("‚úÖ " + data.mensaje);
                        } else {
                            alert("‚ùå " + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("‚ùå Error al eliminar la categor√≠a.");
                    });
            });

        });
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Recargando script de menu-toggle en categor√≠as");
            const menuToggle = document.getElementById("menu-toggle");
            const sidebar = document.getElementById("sidebar");
            const pageContent = document.getElementById("page-content");

            menuToggle.addEventListener("click", function () {
                sidebar.classList.toggle("hidden");
                pageContent.classList.toggle("expanded");

                let icon = menuToggle.querySelector("i");
                if (sidebar.classList.contains("hidden")) {
                    menuToggle.style.left = "10px";
                    icon.classList.remove("fa-arrow-left");
                    icon.classList.add("fa-arrow-right");
                } else {
                    menuToggle.style.left = "260px";
                    icon.classList.remove("fa-arrow-right");
                    icon.classList.add("fa-arrow-left");
                }
            });
        });
    </script>
    {% endblock %}